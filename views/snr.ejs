<%include header%>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/bootstrap-table.min.css">
    <link rel="stylesheet" href="/stylesheets/dashboard.css">
    <link rel="stylesheet" href="/stylesheets/jquery.jqplot.css">

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-9 col-md-2 sidebar">
                <ul class="nav nav-sidebar" id='city'>
                    <% cities.forEach((city, i) => { %>
                        <li value="<%=city._id%>" <%=i==0 ? "class=active" : '' %>>
                            <a>
                                <%=city.country%>-
                                    <%=city.city%>
                            </a>
                        </li>
                        <% })%>
                </ul>
            </div>

            <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
                <div class="row">
                    <div id="graphic" class="col-md-4"></div>
                    <div id="summary" class="col-md-4"></div>
                    <div class="col-md-2">
                        <label for="ef_time" class="col-md-10 control-label">Effective time</label>
                        <select id='ef_time' class="form-control"></select>
                    </div>
                </div>
                <br>
                <div class="row">
                    <table id="table"></table>
                </div>
            </div>
        </div>
    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/bootstrap-table.min.js"></script>

    <script src="/javascripts/jquery.jqplot.min.js"></script>
    <script src="/javascripts/plugins/jqplot.canvasTextRenderer.min.js"></script>
    <script src="/javascripts/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script src="/javascripts/plugins/jqplot.cursor.min.js"></script>
    <script src="/javascripts/plugins/jqplot.pointLabels.min.js"></script>
    <script src="/javascripts/plugins/jqplot.barRenderer.min.js"></script>
    <script src="/javascripts/plugins/jqplot.categoryAxisRenderer.min.js"></script>

    <script src="//cdn.bootcss.com/babel-standalone/6.23.1/babel.min.js"></script>
    <!--<script src="https://unpkg.com/babel-standalone@6/babel.js"></script>-->
    <script type="text/babel" src="/javascripts/common.js"></script>

    <script type="text/babel">
        function refresh_table(city) {
            $('#table').bootstrapTable({
                url: "/api/stats/snr/json/" + city,
                striped: true,
                pagination: true,
                sidePagination: "server",
                pageSize: 10,
                columns: [{
                    field: 'ip',
                    title: 'IP Address',
                    width: '30%'
                }, {
                    field: 'snr',
                    title: 'SNR',
                    sortable: true,
                    align: 'center',
                    cellStyle: function (value, row, index, field) {
                        var strclass = "";
                        if (value > 25) {
                            strclass = 'success';
                        }
                        else if (value > 15) {
                            strclass = 'info';
                        }
                        else if (value > 5) {
                            strclass = 'warning';
                        }
                        else {
                            strclass = 'danger';
                        }
                        return { classes: strclass }
                    }
                }, {
                    field: 'times',
                    title: 'Update times',
                    width: '20%',
                    align: 'center'
                }, {
                    field: 'updatedAt',
                    title: 'Last updated',
                    width: '30%',
                    sortable: true,
                    align: 'center',
                    formatter: function (value, row, index) {
                        return new Date(Date.parse(value)).toLocaleString()
                    }
                }]
            });
        }

        function request_graphic(city) {
            var time = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : $('#ef_time').val();

            $.getJSON(`/api/stats/snr/city/${city}?t=${time}`, data => {
                console.log("done")
                var plot1 = $.jqplot('graphic', [data], {
                    title: 'SNR distribution',
                    seriesDefaults: {
                        showMarker: false,
                    },
                    cursor: {
                        show: true,
                        zoom: true
                    },
                    axes: {
                        xaxis: {
                            label: "SNR(db)",
                            renderer: $.jqplot.CategoryAxisRenderer,
                        },
                        yaxis: {
                            label: "Peer number",
                            tickOptions: {
                                formatString: '%d'
                            },
                            labelRenderer: $.jqplot.CanvasAxisLabelRenderer
                        }
                    }
                }).replot();
            })
        }

        function request_summary(city) {
            var time = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : $('#ef_time').val();

            $.getJSON(`/api/stats/snr/summary/${city}?t=${time}`, data => {
                $.jqplot('summary', [data], {
                    title: 'Summary(x peer < y)',
                    seriesDefaults: {
                        renderer: $.jqplot.BarRenderer,
                        rendererOptions: {
                            barMargin: 15,
                        },
                        pointLabels: { show: true },
                    },
                    axes: {
                        xaxis: {
                            label: "Factor",
                            renderer: $.jqplot.CategoryAxisRenderer,
                        },
                        yaxis: {
                            label: "SNR(db)",
                            max: 30,
                            tickOptions: {
                                formatString: '%.1f'
                            },
                            labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                        }
                    }

                }).replot();

            })
        }

        [
            [30, "within 0.5 Hour"],
            [60, "within 1 Hour"],
            [120, "within 2 Hour"],
            [240, "within 4 Hour"],
            [0, "All"],
        ].forEach(data => select_draw('#ef_time', data, <%=time %>));

        var city = "<%=cities.length ? cities[0]._id : undefined %>";

        if (city) {
            request_graphic(city);
            request_summary(city);
            refresh_table(city);
            var current
            $("#city").children().click(function (e) {
                $('#table').bootstrapTable('destroy');
                current = $(this).attr('value')
                $(this).siblings().removeClass('active');
                $(this).addClass('active')
                refresh_table(current);
                request_graphic(current);
                request_summary(current);
            })

            $('#ef_time').change(e => {
                request_graphic(current || city, e.target.value);
                request_summary(current || city, e.target.value);
            })
        }
    </script>

<style>

#graphic {
    width: 45%;
    height: 350px
}

#summary {
    width: 30%;
    height: 350px    
}

</style>

    <%include footer%>