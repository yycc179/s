<%include header%>

    <div class="container">

        <table class="table">
            <caption>
                <div class="loading pull-left">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </caption>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Location</th>
                    <th>Mac Address </th>
                    <th>IP Address </th>
                    <th>Manual mode</th>
                    <th>Local(db)</th>
                    <th>target(db)</th>
                    <th>step(db)</th>
                    <th>step time(s)</th>
                    <th>Submit</th>
                </tr>
            </thead>

            <tbody>
                <% datas.forEach(function(data, i){ var man = data.manual%>
                    <tr>
                        <th scope="row">
                            <%=i%>
                        </th>
                        <td>
                            <%=data.city.country%>-
                                <%=data.city.city%>
                        </td>
                        <td>
                            <%=data.mac%>
                        </td>
                        <td>
                            <%=data.ip%>
                        </td>
                        <td>
                            <input id="checkbox_<%=i%>" type="checkbox" <%=!data.auto ? "checked": ""%>>
                        </td>
                        <td id='<%=data._id%>'>
                            <%=data.local%>
                        </td>
                        <td>
                            <input type="number" class="form-control input_<%=i%>" name="target" min="0" max="30" step="0.5" value=<%=man?man.target:3%>
                            <%=data.auto?"disabled":""%>>
                        </td>
                        <td>
                            <input type="number" class="form-control input_<%=i%>" name="step" min="0.25" max="2" step="0.25" value=<%=man?man.step:0.25%>
                            <%=data.auto?"disabled":""%>>
                        </td>
                        <td>
                            <input type="number" class="form-control input_<%=i%>" name="step_time" min="1" max="5" step="1" value=<%=man?man.step_time:5%>
                            <%=data.auto ?"disabled":""%>>
                        </td>
                        <td>
                            <button id="submit_<%=i%>" type="submit" class="btn btn-default glyphicon glyphicon-ok pull-right" value="<%=data._id%>"></button>
                        </td>
                    </tr>
                    <% })%>
            </tbody>
        </table>
    </div>

    <script>
        $('input[type=checkbox]').change(e => {
            var id = e.target.id.split('_')[1];
            $('.input_' + id).attr('disabled', !e.target.checked)
        })

        $('button').click(function (e) {
            var id = e.target.id.split('_')[1];
            var obj = {
                auto: $('#checkbox_' + id).is(':checked') ? false : true
            }
            if (!obj.auto) {
                var manual = {}
                for (one of $('.input_' + id)) {
                    manual[one.name] = one.value;
                }
                obj.manual = manual;
            }

            $.ajax({
                type: "post",
                url: '/web/qos/' + this.value,
                data: JSON.stringify(obj),
                contentType: "application/json",
                dataType: 'json',
                error: () => alert('setting fail!'),
                success: () => alert('ok!')
            });
        })

        setInterval(function () {
            // $('#loading').removeClass('hidden')
            $.getJSON('/web/qos/local', datas => {
                for (one of datas) {
                    $('#' + one._id).text(one.local)
                    // $('#loading').addClass('hidden')
                }
            })
        }, 5000)
    </script>

    <style>
        .loading {
            width: 150px;
            height: 15px;
            margin: 0 auto;
            position: relative;
        }
        
        .loading span {
            position: absolute;
            width: 15px;
            height: 100%;
            border-radius: 50%;
            background: lightgreen;
            -webkit-animation: load 1.04s ease-in infinite alternate;
        }
        
        @-webkit-keyframes load {
            0% {
                opacity: 1;
                -webkit-transform: translate(0px);
            }
            100% {
                opacity: 0.2;
                -webkit-transform: translate(150px);
            }
        }
        
        .loading span:nth-child(1) {
            -webkit-animation-delay: 0.13s;
        }
        
        .loading span:nth-child(2) {
            -webkit-animation-delay: 0.26s;
        }
        
        .loading span:nth-child(3) {
            -webkit-animation-delay: 0.39s;
        }
        
        .loading span:nth-child(4) {
            -webkit-animation-delay: 0.52s;
        }
        
        .loading span:nth-child(5) {
            -webkit-animation-delay: 0.65s;
        }
    </style>
    <%include footer%>